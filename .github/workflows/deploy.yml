name: deploy

permissions:
  id-token: write
  contents: read

on:
  workflow_dispatch:
    inputs:
      pick_build:
        description: 'Which build to deploy'
        required: true
        type: choice
        options:
          - latest
          - latest-success
          - by-run-id
        default: latest
      run_id:
        description: 'If you chose by-run-id, paste the Actions run id here'
        required: false
        type: string

jobs:
  pick-run:
    name: pick-run
    runs-on: ubuntu-latest
    outputs:
      picked-run-id: ${{ steps.emit.outputs.picked_run_id }}
    steps:
      - name: Decide which run to deploy (minimal logic)
        id: emit
        run: |
          set -euo pipefail
          PICK="${{ github.event.inputs.pick_build }}"
          INPUT_RUN="${{ github.event.inputs.run_id }}"
          # If user chose by-run-id, return that run id. Otherwise return empty to indicate "use current run"
          if [ "$PICK" = "by-run-id" ] && [ -n "$INPUT_RUN" ]; then
            echo "::set-output name=picked_run_id::$INPUT_RUN"
          else
            # empty indicates "artifact live in current run" and central workflow should use actions/download-artifact fallback
            echo "::set-output name=picked_run_id::"
          fi

  deploy:
    name: deploy (call central)
    needs: pick-run
    uses: jamesandrewmyers/aws-devops/.github/workflows/cdk-deploy-env.yml@master
    with:
      artifact-name: 'lambda-bundle'
      # point central workflow to the central CDK app (central repo will be checked out by the reusable workflow)
      cdk-dir: 'aws-devops-repo/iac/cdk'
      stack: 'api-service-test-dev'
      aws-account: '444101352833'
      aws-region: 'us-west-2'
      # prefer inputs.role-to-assume if you want, otherwise keep empty and pass secret below
      role-to-assume: ''
      artifact-run-id: ${{ needs.pick-run.outputs.picked-run-id }}
    secrets:
      # the reusable workflow declared this secret; supply it from repo secrets
      GITHUB_OIDC_ROLE_ARN: ${{ secrets.GITHUB_OIDC_ROLE_ARN }}