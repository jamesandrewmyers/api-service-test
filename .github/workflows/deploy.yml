name: deploy

permissions:
  id-token: write
  contents: read

on:
  workflow_dispatch:
    inputs:
      pick_build:
        description: 'Which build to deploy'
        required: true
        type: choice
        options:
          - latest
          - latest-success
          - by-run-id
        default: latest
      run_id:
        description: 'If you chose by-run-id, paste the Actions run id here'
        required: false
        type: string

jobs:
  pick-run:
    name: pick-run
    runs-on: ubuntu-latest
    outputs:
      picked_run_id: ${{ steps.emit.outputs.picked_run_id }}
    steps:
      - name: Decide which run to deploy (minimal, deterministic)
        id: emit
        run: |
          set -euo pipefail
          PICK="${{ github.event.inputs.pick_build }}"
          INPUT_RUN="${{ github.event.inputs.run_id }}"
          # If 'by-run-id' and run_id provided, emit it; otherwise emit empty (meaning "use current run" fallback).
          if [ "$PICK" = "by-run-id" ] && [ -n "$INPUT_RUN" ]; then
            echo "picked_run_id=$INPUT_RUN" >> "$GITHUB_OUTPUT"
          else
            echo "picked_run_id=" >> "$GITHUB_OUTPUT"
          fi

  show-picked:
    name: debug: show picked run id
    runs-on: ubuntu-latest
    needs: pick-run
    steps:
      - name: Print picked_run_id (debug)
        run: |
          echo "DEBUG: needs.pick-run.outputs.picked_run_id='${{ needs.pick-run.outputs.picked_run_id }}'"
          if [ -n "${{ needs.pick-run.outputs.picked_run_id }}" ]; then
            echo "DEBUG: will pass run id to central deploy: ${{ needs.pick-run.outputs.picked_run_id }}"
          else
            echo "DEBUG: picked_run_id empty -> central workflow should fallback to current run artifact"
          fi

  deploy:
    name: deploy (call central)
    needs: [pick-run, show-picked]
    # call the reusable workflow in aws-devops; ensure you use @master if your trunk is master
    uses: jamesandrewmyers/aws-devops/.github/workflows/cdk-deploy-env.yml@master
    with:
      artifact-name: 'lambda-bundle'
      cdk-dir: 'aws-devops-repo/iac/cdk'
      stack: 'api-service-test-dev'
      aws-account: '444101352833'
      aws-region: 'us-west-2'
      role-to-assume: 'arn:aws:iam::444101352833:role/gha-cdk-deploy-dev'
      # forward the pick-run job output (empty string allowed)
      artifact-run-id: ${{ needs.pick-run.outputs.picked_run_id }}
    secrets:
      # forward the repo token so the reusable workflow can call the Actions API when needed
      FORWARDED_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # optional: forward OIDC role secret if you use it as fallback
      FORWARDED_OIDC_ROLE_ARN: ${{ secrets.GITHUB_OIDC_ROLE_ARN }}
